// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// === משק בית (Household) ===
model Household {
  id        String   @id @default(cuid())
  name      String   @default("הבית שלי")
  createdAt DateTime @default(now())

  members      HouseholdMember[]
  invites      HouseholdInvite[]
  settings     AppSettings?
  categories   Category[]
  transactions Transaction[]
  budgetItems  BudgetItem[]
  savingsGoals SavingsGoal[]
  loans        Loan[]
}

model HouseholdMember {
  id          String     @id @default(cuid())
  householdId String
  household   Household  @relation(fields: [householdId], references: [id], onDelete: Cascade)
  userId      String     @unique
  role        MemberRole @default(MEMBER)
  displayName String?
  joinedAt    DateTime   @default(now())

  @@index([householdId])
}

enum MemberRole {
  OWNER
  MEMBER
}

model HouseholdInvite {
  id           String    @id @default(cuid())
  householdId  String
  household    Household @relation(fields: [householdId], references: [id], onDelete: Cascade)
  token        String    @unique @default(cuid())
  expiresAt    DateTime
  usedAt       DateTime?
  usedByUserId String?
  createdAt    DateTime  @default(now())

  @@index([token])
  @@index([householdId])
}

// === קטגוריות ===
model Category {
  id              String        @id @default(cuid())
  householdId     String?       // null = קטגוריית מערכת
  household       Household?    @relation(fields: [householdId], references: [id], onDelete: Cascade)
  name            String
  icon            String?
  color           String?
  type            CategoryType
  isFixed         Boolean       @default(false)
  parentId        String?
  parent          Category?     @relation("SubCategories", fields: [parentId], references: [id])
  children        Category[]    @relation("SubCategories")
  sortOrder       Int           @default(0)
  isActive        Boolean       @default(true)
  isDefault       Boolean       @default(true)
  createdAt       DateTime      @default(now())

  transactions    Transaction[]
  budgetItems     BudgetItem[]

  @@index([householdId])
}

enum CategoryType {
  INCOME
  EXPENSE
}

// === עסקאות (הכנסות והוצאות) ===
model Transaction {
  id              String          @id @default(cuid())
  householdId     String
  household       Household       @relation(fields: [householdId], references: [id], onDelete: Cascade)
  amount          Decimal         @db.Decimal(10, 2)
  type            TransactionType
  categoryId      String
  category        Category        @relation(fields: [categoryId], references: [id])
  date            DateTime
  weekNumber      Int?
  isFixed         Boolean         @default(false)
  notes           String?
  tags            String[]
  isRecurring     Boolean         @default(false)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([householdId])
  @@index([date])
  @@index([categoryId])
  @@index([type, date])
}

enum TransactionType {
  INCOME
  EXPENSE
}

// === תקציב חודשי ===
model BudgetItem {
  id              String    @id @default(cuid())
  householdId     String
  household       Household @relation(fields: [householdId], references: [id], onDelete: Cascade)
  categoryId      String
  category        Category  @relation(fields: [categoryId], references: [id])
  month           Int
  year            Int
  plannedAmount   Decimal   @db.Decimal(10, 2)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([householdId, categoryId, month, year])
  @@index([householdId])
  @@index([month, year])
}

// === מטרות חיסכון ===
model SavingsGoal {
  id              String    @id @default(cuid())
  householdId     String
  household       Household @relation(fields: [householdId], references: [id], onDelete: Cascade)
  name            String
  icon            String?
  targetAmount    Decimal   @db.Decimal(10, 2)
  currentAmount   Decimal   @db.Decimal(10, 2) @default(0)
  targetDate      DateTime?
  monthlyTarget   Decimal?  @db.Decimal(10, 2)
  color           String?
  isCompleted     Boolean   @default(false)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  deposits        SavingsDeposit[]

  @@index([householdId])
}

model SavingsDeposit {
  id              String      @id @default(cuid())
  goalId          String
  goal            SavingsGoal @relation(fields: [goalId], references: [id], onDelete: Cascade)
  amount          Decimal     @db.Decimal(10, 2)
  date            DateTime
  notes           String?
  createdAt       DateTime    @default(now())
}

// === הלוואות וחובות ===
model Loan {
  id              String     @id @default(cuid())
  householdId     String
  household       Household  @relation(fields: [householdId], references: [id], onDelete: Cascade)
  name            String
  type            LoanType
  originalAmount  Decimal    @db.Decimal(10, 2)
  remainingAmount Decimal    @db.Decimal(10, 2)
  monthlyPayment  Decimal    @db.Decimal(10, 2)
  interestRate    Decimal?   @db.Decimal(5, 3)
  startDate       DateTime
  endDate         DateTime?
  totalPayments   Int?
  remainingPayments Int?
  notes           String?
  isActive        Boolean    @default(true)
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  payments        LoanPayment[]

  @@index([householdId])
}

enum LoanType {
  MORTGAGE
  BANK
  EXTERNAL
  CREDIT
  OTHER
}

model LoanPayment {
  id              String   @id @default(cuid())
  loanId          String
  loan            Loan     @relation(fields: [loanId], references: [id], onDelete: Cascade)
  amount          Decimal  @db.Decimal(10, 2)
  principalAmount Decimal? @db.Decimal(10, 2)
  interestAmount  Decimal? @db.Decimal(10, 2)
  date            DateTime
  notes           String?
  createdAt       DateTime @default(now())
}

// === הגדרות אפליקציה ===
model AppSettings {
  id              String    @id @default(cuid())
  householdId     String    @unique
  household       Household @relation(fields: [householdId], references: [id], onDelete: Cascade)
  payday          Int       @default(11)
  currency        String    @default("ILS")
  startMonth      Int       @default(1)
  weekStartDay    Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}
